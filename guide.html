<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>智慧行動導覽系統</title>
    
    <!-- PWA 核心配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="智慧結構化文本行動導覽系統">
    
    <!-- PWA Manifest (Data URI 內嵌) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"智慧行動導覽系統","short_name":"行動導覽","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#1e40af","icons":[{"src":"https://img.icons8.com/ios-filled/192/1e40af/stack.png","sizes":"192x192","type":"image/png"},{"src":"https://img.icons8.com/ios-filled/512/1e40af/stack.png","sizes":"512x512","type":"image/png"}]}'>

    <!-- iOS 專用圖標 -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/1e40af/stack.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/50/1e40af/stack.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9) translate(-50%, -50%); }
            to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
        }
        .animate-zoomIn { 
            animation: zoomIn 0.2s ease-out forwards;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
        }
        
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-dropdown { animation: fadeInDown 0.2s ease-out forwards; }
        
        * { -webkit-tap-highlight-color: transparent; }
        
        .text-shadow-white { text-shadow: 0 1px 3px rgba(255,255,255,0.9); }

        /* 引 [Quote] 樣式優化：正體、大方行距 */
        .quote-style {
            line-height: 2;
            font-style: normal;
        }
        
        .content-scroll-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-white overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;
        
        const Icons = {
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
            X: ({ size = 32 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ChevronDown: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            RefreshCw: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isSecDropdownOpen, setIsSecDropdownOpen] = useState(false);
            const [activePartIdx, setActivePartIdx] = useState(null);
            const [activeChapIdx, setActiveChapIdx] = useState(null);
            const [activeSecIdx, setActiveSecIdx] = useState(-1); 
            const [viewMode, setViewMode] = useState("welcome"); 
            const [isLoading, setIsLoading] = useState(false);
            const [expandedPartIdx, setExpandedPartIdx] = useState(null);
            const contentScrollRef = useRef(null);

            // 固定後端資料來源
            const cloudUrl = "https://docs.google.com/document/d/1MklGqY-E5bEDl6eR0Qqt3ZM_T6qMztY92IXPWZt4Iqk/edit?usp=drive_link";

            const sanitizeTitle = (str) => {
                if (!str) return "";
                const noHtml = str.replace(/<[^>]*>?/gm, '');
                return noHtml.replace(/\\n|\\t|\\r/g, '').replace(/[\r\n\t]/g, '').trim().replace(/\s+/g, ' ');
            };

            const unescapeContent = (str) => {
                if (!str) return "";
                const noHtml = str.replace(/<[^>]*>?/gm, '');
                return noHtml.replace(/\\n/g, '\n').replace(/\\t/g, '    ');
            };

            const parseText = useCallback((raw) => {
                const results = [];
                const tagRegex = /\[(.*?)\]/g;
                let match, tokens = [];
                while ((match = tagRegex.exec(raw)) !== null) {
                    tokens.push({ type: match[1], index: match.index, fullTag: match[0], contentStart: match.index + match[0].length });
                }
                const sectionsWithContent = tokens.map((token, i) => {
                    const nextIndex = tokens[i + 1] ? tokens[i + 1].index : raw.length;
                    const rawContent = raw.substring(token.contentStart, nextIndex);
                    if (["篇", "章", "節"].includes(token.type)) {
                        return { type: token.type, content: sanitizeTitle(rawContent) };
                    } else {
                        return { type: token.type, content: unescapeContent(rawContent) };
                    }
                });

                let currentPart = null, currentChap = null, currentSec = null;
                sectionsWithContent.forEach((item) => {
                    if (item.type === "篇") {
                        currentPart = { title: item.content, quote: "", chapters: [] };
                        results.push(currentPart);
                        currentChap = null; currentSec = null;
                    } else if (item.type === "章") {
                        if (!currentPart) return;
                        currentChap = { title: item.content, content: "", media: "", quote: "", sections: [] };
                        currentPart.chapters.push(currentChap);
                        currentSec = null;
                    } else if (item.type === "節") {
                        if (!currentChap) return;
                        currentSec = { subtitle: item.content, content: "", media: "", quote: "" };
                        currentChap.sections.push(currentSec);
                    } else if (["文", "圖", "影", "引"].includes(item.type)) {
                        const target = currentSec || currentChap || currentPart;
                        if (!target) return;
                        if (item.type === "文") target.content = (target.content || "") + item.content;
                        else if (item.type === "圖" || item.type === "影") target.media = item.content.trim();
                        else if (item.type === "引") target.quote = (target.quote || "") + item.content;
                    }
                });
                return results;
            }, []);

            const performLoad = async (url) => {
                if (!url) return;
                setIsLoading(true);
                try {
                    let fetchUrl = url;
                    if (url.includes("docs.google.com/document/d/")) {
                        const docId = url.match(/\/d\/(.*?)\//)?.[1];
                        if (docId) fetchUrl = `https://docs.google.com/document/d/${docId}/export?format=txt`;
                    }
                    const response = await fetch(fetchUrl);
                    const text = await response.text();
                    const parsedData = parseText(text);
                    if (parsedData.length > 0) {
                        setData(parsedData);
                        setActivePartIdx(0); setActiveChapIdx(0); setActiveSecIdx(-1);
                        setViewMode("part");
                        setExpandedPartIdx(null); 
                    }
                } catch (err) { console.error("載入失敗", err); }
                finally { setIsLoading(false); }
            };

            // 啟動即自動載入內容
            useEffect(() => { performLoad(cloudUrl); }, []);

            const currentPart = data[activePartIdx];
            const currentChap = currentPart?.chapters[activeChapIdx];
            const currentDisplayItem = viewMode === "part" ? currentPart : (activeSecIdx === -1 ? currentChap : currentChap?.sections[activeSecIdx]);
            const defaultPlaceholder = "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=800";

            const handleChapChange = (cIdx) => {
                setActiveChapIdx(cIdx);
                setActiveSecIdx(-1);
                setViewMode("chapter");
                setIsMenuOpen(false);
                if (contentScrollRef.current) contentScrollRef.current.scrollTop = 0;
            };

            const goToNext = () => {
                if (!data.length) return;
                const p = data[activePartIdx];
                const c = p.chapters[activeChapIdx];

                if (viewMode === "part") {
                    if (p.chapters.length > 0) { setActiveChapIdx(0); setActiveSecIdx(-1); setViewMode("chapter"); }
                    else if (activePartIdx + 1 < data.length) { setActivePartIdx(activePartIdx + 1); setViewMode("part"); }
                } else if (viewMode === "chapter") {
                    if (activeSecIdx < (c?.sections?.length || 0) - 1) { setActiveSecIdx(activeSecIdx + 1); }
                    else if (activeChapIdx < p.chapters.length - 1) { setActiveChapIdx(activeChapIdx + 1); setActiveSecIdx(-1); }
                    else if (activePartIdx < data.length - 1) { setActivePartIdx(activePartIdx + 1); setViewMode("part"); }
                }
                if (contentScrollRef.current) contentScrollRef.current.scrollTop = 0;
            };

            const isLastItem = () => {
                if (!data.length) return true;
                const isLastPart = activePartIdx === data.length - 1;
                const p = data[activePartIdx];
                const isLastChap = activeChapIdx === p.chapters.length - 1;
                const c = p.chapters[activeChapIdx];
                const isLastSec = activeSecIdx === (c?.sections?.length || 0) - 1;
                if (viewMode === "part" && p.chapters.length === 0 && isLastPart) return true;
                if (viewMode === "chapter" && isLastChap && isLastSec && isLastPart) return true;
                return false;
            };

            return (
                <div className="flex flex-col h-screen bg-white overflow-hidden relative font-sans text-gray-900">
                    {/* 目錄索引頁 */}
                    {isMenuOpen && (
                        <div className="fixed inset-0 z-50 flex items-start justify-center">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-[2px]" onClick={() => setIsMenuOpen(false)}></div>
                            <aside className="animate-zoomIn w-[94%] h-[calc(100%-100px)] mt-6 bg-white/90 backdrop-blur-2xl shadow-2xl rounded-[2.5rem] flex flex-col border border-white/40 overflow-hidden">
                                <div className="p-8 border-b border-gray-200/20 flex justify-between items-center bg-white/20">
                                    <span className="font-black text-3xl tracking-tighter text-gray-900 uppercase">索引目錄</span>
                                    <button onClick={() => setIsMenuOpen(false)} className="p-2 bg-gray-100 rounded-full"><Icons.X size={24} /></button>
                                </div>
                                <nav className="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                                    {data.map((part, pIdx) => (
                                        <div key={pIdx} className="mb-4 flex flex-col items-center w-full">
                                            <div 
                                                className={`w-full rounded-3xl font-black text-xl flex items-center transition-all overflow-hidden border ${activePartIdx === pIdx ? 'bg-blue-600 text-white border-blue-500 shadow-lg' : 'bg-gray-50 text-gray-700 border-gray-100'}`}
                                            >
                                                <div className="flex-1 py-6 px-6 select-none flex justify-between items-center" onClick={() => setExpandedPartIdx(expandedPartIdx === pIdx ? null : pIdx)}>
                                                    <span className="truncate">{part.title}</span>
                                                    <Icons.ChevronDown className={`transition-transform duration-300 ${expandedPartIdx === pIdx ? 'rotate-180' : ''}`} />
                                                </div>
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); setActivePartIdx(pIdx); setViewMode("part"); setIsMenuOpen(false); }}
                                                    className={`px-8 py-6 border-l font-black text-lg transition-colors ${activePartIdx === pIdx ? 'bg-white/10 border-white/20 active:bg-white/20' : 'bg-white border-gray-100 active:bg-blue-50 text-blue-600'}`}
                                                >
                                                    進入
                                                </button>
                                            </div>
                                            {expandedPartIdx === pIdx && (
                                                <div className="mt-2 w-full flex flex-col items-center space-y-1 animate-dropdown bg-gray-50/50 rounded-3xl p-2 border border-gray-100/50">
                                                    {part.chapters.map((chap, cIdx) => (
                                                        <button key={cIdx} onClick={() => { setActivePartIdx(pIdx); handleChapChange(cIdx); }} className={`w-full py-5 px-6 text-xl font-bold text-left transition-all rounded-2xl ${activeChapIdx === cIdx && activePartIdx === pIdx && viewMode !== "part" ? "bg-blue-100 text-blue-800" : "text-gray-500 active:bg-gray-100"}`}>
                                                            {chap.title}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </nav>
                                <div className="p-8 text-center text-xs font-bold text-gray-400 tracking-[0.2em] uppercase opacity-40">Guidebook Navigation</div>
                            </aside>
                        </div>
                    )}

                    {/* 主要內容區域 */}
                    <div className="flex-1 flex flex-col overflow-hidden pb-16">
                        {currentDisplayItem ? (
                            <div className="flex flex-col h-full overflow-hidden">
                                <section className="h-[40vh] w-full relative bg-gray-200 shrink-0">
                                    <MediaRenderer content={currentDisplayItem.media} placeholder={defaultPlaceholder} />
                                    <div className="absolute inset-0 bg-gradient-to-t from-white via-white/10 to-transparent"></div>
                                    <div onClick={() => setIsMenuOpen(true)} className="absolute bottom-8 left-8 right-8 text-center cursor-pointer active:scale-95 transition-transform">
                                        <h1 className="text-3xl font-black text-gray-900 leading-tight text-shadow-white tracking-tighter">
                                            {viewMode === "part" ? currentPart.title : (activeSecIdx === -1 ? currentChap?.title : currentChap?.sections[activeSecIdx].subtitle)}
                                        </h1>
                                    </div>
                                </section>

                                {viewMode !== "part" && currentChap?.sections?.length > 0 && (
                                    <div className="bg-white/95 backdrop-blur-md z-20 border-b shrink-0">
                                        <button onClick={() => setIsSecDropdownOpen(!isSecDropdownOpen)} className="w-full px-8 py-5 flex items-center justify-between text-blue-800 font-black text-sm uppercase tracking-widest relative">
                                            <div className="flex items-center gap-2">
                                                <Icons.List />
                                                <span>{activeSecIdx === -1 ? "看更多內容" : currentChap.sections[activeSecIdx].subtitle}</span>
                                            </div>
                                            <Icons.ChevronDown className={`transition-transform duration-300 ${isSecDropdownOpen ? 'rotate-180' : ''}`} />
                                        </button>
                                        {isSecDropdownOpen && (
                                            <div className="absolute top-full left-0 right-0 bg-white shadow-2xl border-b animate-dropdown z-30">
                                                <div className="flex flex-col py-2 max-h-[45vh] overflow-y-auto">
                                                    <button onClick={() => { setActiveSecIdx(-1); setIsSecDropdownOpen(false); }} className="px-8 py-6 text-center text-sm font-black text-blue-600 bg-blue-50 border-b border-blue-100 flex items-center justify-center gap-3">
                                                        <Icons.RefreshCw /> <span>回到本段落</span>
                                                    </button>
                                                    {currentChap.sections.map((sec, sIdx) => (
                                                        <button key={sIdx} onClick={() => { setActiveSecIdx(sIdx); setIsSecDropdownOpen(false); }} className={`px-8 py-5 text-center text-lg font-bold border-b border-gray-50 ${activeSecIdx === sIdx ? 'bg-blue-100 text-blue-900' : 'text-gray-600 active:bg-gray-100'}`}>
                                                            {sec.subtitle}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <section ref={contentScrollRef} className="flex-1 overflow-y-auto no-scrollbar content-scroll-area bg-white">
                                    <div className="p-8 pb-32 flex flex-col items-center">
                                        <div className="max-w-xl w-full">
                                            {/* ✨ [引] 排版：縮小字體 text-lg */}
                                            {currentDisplayItem.quote && (
                                                <div className="quote-style mb-12 text-center text-lg md:text-xl font-medium text-gray-500 whitespace-pre-wrap border-y border-gray-100 py-12 bg-gray-50/50 rounded-3xl px-8 shadow-inner">
                                                    {currentDisplayItem.quote}
                                                </div>
                                            )}

                                            {/* ✨ [文] 排版：縮小字體 text-xl */}
                                            <article className="flex justify-center w-full">
                                                <div className="w-full max-w-2xl text-left whitespace-pre-wrap text-xl font-normal text-gray-800 leading-relaxed">
                                                    {currentDisplayItem.content || (
                                                        <div className="h-48 flex items-center justify-center text-gray-200 text-sm font-black tracking-widest border-2 border-dashed border-gray-100 rounded-3xl italic uppercase">Content Loading...</div>
                                                    )}
                                                </div>
                                            </article>

                                            {!isLastItem() && (
                                                <div className="mt-20 pt-10 border-t border-gray-100 w-full flex justify-center animate-content">
                                                    <button onClick={goToNext} className="w-full py-8 bg-blue-700 text-white rounded-[2.5rem] shadow-xl flex items-center justify-center gap-4 active:scale-[0.98] active:bg-blue-800 transition-all shadow-blue-200">
                                                        <span className="text-2xl font-black tracking-widest uppercase">往下一節內容</span>
                                                        <Icons.ArrowRight />
                                                    </button>
                                                </div>
                                            )}

                                            {isLastItem() && (
                                                <div className="mt-20 text-center text-gray-300 font-black text-sm uppercase tracking-[0.4em] py-10 border-t border-gray-50">End of Document</div>
                                            )}
                                        </div>
                                    </div>
                                </section>
                            </div>
                        ) : (
                            /* 試營運載入畫面 */
                            <div className="h-full flex flex-col items-center justify-center bg-gray-50 p-12 text-center animate-content">
                                <div className="text-blue-700 mb-8 opacity-60">
                                    <Icons.RefreshCw />
                                </div>
                                <h2 className="text-2xl font-black text-gray-400 tracking-tighter uppercase">正在同步最新導覽內容...</h2>
                            </div>
                        )}
                    </div>

                    {/* ✨ 底部整列式導覽按鈕：已移除數字指示器 */}
                    {data.length > 0 && (
                        <footer 
                            onClick={() => setIsMenuOpen(true)}
                            className="fixed bottom-0 left-0 right-0 h-24 bg-blue-700 text-white flex items-center justify-center z-40 shadow-[0_-10px_30px_rgba(30,64,175,0.3)] pb-safe active:bg-blue-800 transition-colors"
                        >
                            <div className="flex items-center gap-6">
                                <Icons.Menu />
                                <span className="text-3xl font-black tracking-[0.2em] uppercase">按我進目錄</span>
                            </div>
                        </footer>
                    )}
                </div>
            );
        };

        // 媒體渲染輔助
        const MediaRenderer = ({ content, placeholder }) => {
            if (!content) return <img src={placeholder} className="w-full h-full object-cover opacity-40 grayscale" />;
            if (content.trim().startsWith('<')) return <div className="w-full h-full bg-black flex items-center justify-center relative" dangerouslySetInnerHTML={{ __html: content }} />;
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const ytMatch = content.match(youtubeRegex);
            if (ytMatch) return <iframe className="w-full h-full bg-black" src={`https://www.youtube.com/embed/${ytMatch[1]}?autoplay=0&rel=0`} frameBorder="0" allowFullScreen></iframe>;
            const videoRegex = /\.(mp4|webm|ogg|mov)$/i;
            if (videoRegex.test(content)) return <video className="w-full h-full object-contain bg-black" controls playsInline><source src={content} /></video>;
            return <img src={content} className="w-full h-full object-cover animate-fadeIn" />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // ✨ PWA Service Worker 動態註冊（支援離線安裝）
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'guide-v1';
                self.addEventListener('install', (e) => {
                    e.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll([location.href])));
                });
                self.addEventListener('fetch', (e) => {
                    e.respondWith(caches.match(e.request).then((res) => res || fetch(e.request)));
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(() => {});
        }
    </script>
</body>
</html>
