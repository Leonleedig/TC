<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>測試版導覽冊</title>
    
       <!-- PWA 核心配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="準導覽冊">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e40af">
    
    <!-- ✨ 正式寫法：連結到實體 manifest.json 檔案 -->
    <link rel="manifest" href="manifest.json">

    <!-- ✨ 建議準備實體圖示檔存放於同目錄 -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9) translate(-50%, -50%); }
            to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
        }
        .animate-zoomIn { 
            animation: zoomIn 0.2s ease-out forwards;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
        }
        
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-dropdown { animation: fadeInDown 0.2s ease-out forwards; }
        
        * { -webkit-tap-highlight-color: transparent; }
        
        .text-shadow-white { text-shadow: 0 1px 3px rgba(255,255,255,0.9); }

        .quote-style {
            line-height: 2;
            font-style: normal;
        }
        
        .content-scroll-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 選單細線樣式 */
        hr { border: 0; border-top: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-white overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;
        
        const Icons = {
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
            X: ({ size = 32 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ChevronDown: ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            RefreshCw: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [isMenuOpen, setIsMenuOpen] = useState(true);
            const [isSecDropdownOpen, setIsSecDropdownOpen] = useState(false);
            const [activePartIdx, setActivePartIdx] = useState(null);
            const [activeChapIdx, setActiveChapIdx] = useState(null);
            const [activeSecIdx, setActiveSecIdx] = useState(-1); 
            const [viewMode, setViewMode] = useState("welcome"); 
            const [isLoading, setIsLoading] = useState(false);
            const [expandedPartIdx, setExpandedPartIdx] = useState(null);
            const contentScrollRef = useRef(null);
            
            // 字體大小與語音狀態
            const [fontSizeLevel, setFontSizeLevel] = useState(0); 
            const [isSpeaking, setIsSpeaking] = useState(false);

            const cloudUrl = "https://docs.google.com/document/d/1MklGqY-E5bEDl6eR0Qqt3ZM_T6qMztY92IXPWZt4Iqk/edit?usp=drive_link";

            const getFontSizeClass = (baseSize) => {
                const sizes = {
                    'quote': ['text-lg', 'text-xl', 'text-2xl'],
                    'content': ['text-xl', 'text-2xl', 'text-3xl'],
                    'icon': ['text-xl', 'text-2xl', 'text-3xl'] 
                };
                return sizes[baseSize] ? sizes[baseSize][fontSizeLevel] : sizes['content'][fontSizeLevel];
            };

            const toggleFontSize = () => {
                setFontSizeLevel(prev => (prev + 1) % 3);
            };

            // ✨ 停止語音
            const stopSpeech = () => {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
            };

            // 語音朗讀邏輯
            const toggleSpeech = () => {
                if (isSpeaking) {
                    stopSpeech();
                } else {
                    const currentPart = data[activePartIdx];
                    const currentChap = currentPart?.chapters[activeChapIdx];
                    const item = viewMode === "part" ? currentPart : (activeSecIdx === -1 ? currentChap : currentChap?.sections[activeSecIdx]);
                    
                    let title = "";
                    if (viewMode === "part") title = currentPart?.title;
                    else if (activeSecIdx === -1) title = currentChap?.title;
                    else title = currentChap?.sections[activeSecIdx]?.subtitle;

                    const textParts = [title, item?.quote, item?.content];
                    const text = textParts.filter(Boolean).join("。"); 

                    if (!text.trim()) return;

                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-TW';
                    utterance.rate = 0.9;
                    utterance.onend = () => setIsSpeaking(false);
                    window.speechSynthesis.speak(utterance);
                    setIsSpeaking(true);
                }
            };

            const sanitizeTitle = (str) => {
                if (!str) return "";
                const noHtml = str.replace(/<[^>]*>?/gm, '');
                return noHtml.replace(/\\n|\\t|\\r/g, '').replace(/[\r\n\t]/g, '').trim().replace(/\s+/g, ' ');
            };

            const unescapeContent = (str) => {
                if (!str) return "";
                const noHtml = str.replace(/<[^>]*>?/gm, '');
                return noHtml.replace(/\\n/g, '\n').replace(/\\t/g, '    ');
            };

            const parseText = useCallback((raw) => {
                const results = [];
                const tagRegex = /\[(.*?)\]/g;
                let match, tokens = [];
                while ((match = tagRegex.exec(raw)) !== null) {
                    tokens.push({ type: match[1], index: match.index, fullTag: match[0], contentStart: match.index + match[0].length });
                }
                const sectionsWithContent = tokens.map((token, i) => {
                    const nextIndex = tokens[i + 1] ? tokens[i + 1].index : raw.length;
                    const rawContent = raw.substring(token.contentStart, nextIndex);
                    if (["篇", "章", "節"].includes(token.type)) {
                        return { type: token.type, content: sanitizeTitle(rawContent) };
                    } else {
                        return { type: token.type, content: unescapeContent(rawContent) };
                    }
                });

                let currentPart = null, currentChap = null, currentSec = null;
                sectionsWithContent.forEach((item) => {
                    if (item.type === "篇") {
                        currentPart = { title: item.content, quote: "", chapters: [] };
                        results.push(currentPart);
                        currentChap = null; currentSec = null;
                    } else if (item.type === "章") {
                        if (!currentPart) return;
                        currentChap = { title: item.content, content: "", media: "", quote: "", sections: [] };
                        currentPart.chapters.push(currentChap);
                        currentSec = null;
                    } else if (item.type === "節") {
                        if (!currentChap) return;
                        currentSec = { subtitle: item.content, content: "", media: "", quote: "" };
                        currentChap.sections.push(currentSec);
                    } else if (["文", "圖", "影", "引"].includes(item.type)) {
                        const target = currentSec || currentChap || currentPart;
                        if (!target) return;
                        if (item.type === "文") target.content = (target.content || "") + item.content;
                        else if (item.type === "圖" || item.type === "影") target.media = item.content.trim();
                        else if (item.type === "引") target.quote = (target.quote || "") + item.content;
                    }
                });
                return results;
            }, []);

            const performLoad = async (url) => {
                if (!url) return;
                setIsLoading(true);
                try {
                    let fetchUrl = url;
                    if (url.includes("docs.google.com/document/d/")) {
                        const docId = url.match(/\/d\/(.*?)\//)?.[1];
                        if (docId) fetchUrl = `https://docs.google.com/document/d/${docId}/export?format=txt`;
                    }
                    const response = await fetch(fetchUrl);
                    const text = await response.text();
                    const parsedData = parseText(text);
                    if (parsedData.length > 0) {
                        setData(parsedData);
                        setActivePartIdx(0); setActiveChapIdx(0); setActiveSecIdx(-1);
                        setViewMode("part");
                        setExpandedPartIdx(null); 
                    }
                } catch (err) { console.error("載入失敗", err); }
                finally { setIsLoading(false); }
            };

            useEffect(() => { performLoad(cloudUrl); }, []);

            const currentPart = data[activePartIdx];
            const currentChap = currentPart?.chapters[activeChapIdx];
            const currentDisplayItem = viewMode === "part" ? currentPart : (activeSecIdx === -1 ? currentChap : currentChap?.sections[activeSecIdx]);
            const defaultPlaceholder = "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=800";

            const handleChapChange = (cIdx) => {
                stopSpeech(); // ✨ 換頁停止語音
                setActiveChapIdx(cIdx);
                setActiveSecIdx(-1);
                setViewMode("chapter");
                setIsMenuOpen(false);
                if (contentScrollRef.current) contentScrollRef.current.scrollTop = 0;
            };

            const goToNext = () => {
                if (!data.length) return;
                stopSpeech(); // ✨ 換頁停止語音
                const p = data[activePartIdx];
                const c = p.chapters[activeChapIdx];

                if (viewMode === "part") {
                    if (p.chapters.length > 0) { setActiveChapIdx(0); setActiveSecIdx(-1); setViewMode("chapter"); }
                    else if (activePartIdx + 1 < data.length) { setActivePartIdx(activePartIdx + 1); setViewMode("part"); }
                } else if (viewMode === "chapter") {
                    if (activeSecIdx < (c?.sections?.length || 0) - 1) { setActiveSecIdx(activeSecIdx + 1); }
                    else if (activeChapIdx < p.chapters.length - 1) { setActiveChapIdx(activeChapIdx + 1); setActiveSecIdx(-1); }
                    else if (activePartIdx < data.length - 1) { setActivePartIdx(activePartIdx + 1); setViewMode("part"); }
                }
                if (contentScrollRef.current) contentScrollRef.current.scrollTop = 0;
            };

            const isLastItem = () => {
                if (!data.length) return true;
                const isLastPart = activePartIdx === data.length - 1;
                const p = data[activePartIdx];
                const isLastChap = activeChapIdx === p.chapters.length - 1;
                const c = p.chapters[activeChapIdx];
                const isLastSec = activeSecIdx === (c?.sections?.length || 0) - 1;
                if (viewMode === "part" && p.chapters.length === 0 && isLastPart) return true;
                if (viewMode === "chapter" && isLastChap && isLastSec && isLastPart) return true;
                return false;
            };

            return (
                <div className="flex flex-col h-screen bg-white overflow-hidden relative font-sans text-gray-900">
                    
                    {/* 目錄索引頁 */}
                    {isMenuOpen && (
                        <div className="fixed inset-0 z-50 flex items-start justify-center">
                            <div className="absolute inset-0 bg-black/50 backdrop-blur-[2px]" onClick={() => setIsMenuOpen(false)}></div>
                            <aside className="animate-zoomIn w-[94%] h-[calc(100%-100px)] mt-6 bg-white/90 backdrop-blur-2xl shadow-2xl rounded-[2.5rem] flex flex-col border border-white/40 overflow-hidden">
                                <div className="p-4 md:p-6 border-b border-gray-200/20 flex items-center justify-center relative bg-white/20">
                                    <span className="font-black text-xl tracking-tighter text-gray-900 uppercase">目錄</span>
                                    <button onClick={() => setIsMenuOpen(false)} className="absolute right-4 p-2 bg-gray-100 rounded-full active:scale-90 transition-transform"><Icons.X size={24} /></button>
                                </div>
                                <nav className="flex-1 overflow-y-auto no-scrollbar">
                                    {data.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-gray-400 italic py-20 animate-pulse text-xl">正在同步導覽內容...</div>
                                    ) : (
                                        data.map((part, pIdx) => (
                                            <div key={pIdx} className="flex flex-col w-full">
                                                <div 
                                                    className={`w-full font-black text-xl flex items-center transition-all overflow-hidden border-b border-gray-100 ${activePartIdx === pIdx ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                                                >
                                                    <div className="flex-1 py-6 px-6 select-none flex justify-between items-center" onClick={() => setExpandedPartIdx(expandedPartIdx === pIdx ? null : pIdx)}>
                                                        <span className="truncate">{part.title}</span>
                                                        <Icons.ChevronDown className={`transition-transform duration-300 ${expandedPartIdx === pIdx ? 'rotate-180' : ''}`} />
                                                    </div>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); stopSpeech(); setActivePartIdx(pIdx); setViewMode("part"); setIsMenuOpen(false); }}
                                                        className={`px-8 py-6 border-l font-black text-lg transition-colors ${activePartIdx === pIdx ? 'bg-white/10 border-white/20 active:bg-white/20' : 'bg-gray-50 border-gray-100 text-blue-600'}`}
                                                    >
                                                        進入
                                                    </button>
                                                </div>
                                                
                                                {expandedPartIdx === pIdx && (
                                                    <div className="flex flex-col bg-gray-50/50">
                                                        {part.chapters.map((chap, cIdx) => (
                                                            <div key={cIdx}>
                                                                <button 
                                                                    onClick={() => { setActivePartIdx(pIdx); handleChapChange(cIdx); }} 
                                                                    className={`w-full py-5 px-8 text-xl font-bold text-left transition-all ${activeChapIdx === cIdx && activePartIdx === pIdx && viewMode !== "part" ? "bg-blue-100 text-blue-800" : "text-gray-500 active:bg-gray-100"}`}
                                                                >
                                                                    ● {chap.title}
                                                                </button>
                                                                <hr />
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </nav>
                            </aside>
                        </div>
                    )}

                    {/* 主要內容區域 */}
                    <div className="flex-1 flex flex-col overflow-hidden pb-16">
                        {currentDisplayItem ? (
                            <div className="flex flex-col h-full overflow-hidden">
                                <section className="h-[40vh] w-full relative bg-gray-200 shrink-0">
                                    <MediaRenderer content={currentDisplayItem.media} placeholder={defaultPlaceholder} />
                                    <div className="absolute inset-0 bg-gradient-to-t from-white via-white/10 to-transparent"></div>
                                    <div onClick={() => setIsMenuOpen(true)} className="absolute bottom-8 left-8 right-8 text-center cursor-pointer active:scale-95 transition-transform">
                                        <h1 className="text-3xl font-black text-gray-900 leading-tight text-shadow-white tracking-tighter">
                                            {viewMode === "part" ? currentPart.title : (activeSecIdx === -1 ? currentChap?.title : currentChap?.sections[activeSecIdx].subtitle)}
                                        </h1>
                                    </div>
                                </section>

                                {viewMode !== "part" && currentChap?.sections?.length > 0 && (
                                    <div className="bg-white/95 backdrop-blur-md z-20 border-b shrink-0">
                                        <button 
                                            onClick={() => {
                                                if (isSecDropdownOpen) {
                                                    stopSpeech(); // ✨ 切換回主文也要停語音
                                                    setActiveSecIdx(-1);
                                                }
                                                setIsSecDropdownOpen(!isSecDropdownOpen);
                                            }} 
                                            className="w-full px-8 py-5 flex items-center justify-between text-blue-800 font-black text-sm uppercase tracking-widest relative"
                                        >
                                            <div className="flex items-center gap-2">
                                                <Icons.List />
                                                <span>{isSecDropdownOpen ? "回到本文" : "更多內容⋯"}</span>
                                            </div>
                                            <Icons.ChevronDown className={`transition-transform duration-300 ${isSecDropdownOpen ? 'rotate-180' : ''}`} />
                                        </button>
                                        
                                        {isSecDropdownOpen && (
                                            <div className="absolute top-full left-0 right-0 bg-white shadow-2xl border-b animate-dropdown z-30">
                                                <div className="flex flex-col pt-2 pb-32 max-h-[45vh] overflow-y-auto no-scrollbar">
                                                    {currentChap.sections.map((sec, sIdx) => (
                                                        <button 
                                                            key={sIdx} 
                                                            onClick={() => { stopSpeech(); setActiveSecIdx(sIdx); setIsSecDropdownOpen(false); }} 
                                                            className={`px-8 py-5 text-center text-lg font-bold border-b border-gray-50 ${activeSecIdx === sIdx ? 'bg-blue-100 text-blue-900' : 'text-gray-600 active:bg-gray-100'}`}
                                                        >
                                                            {sec.subtitle}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <section ref={contentScrollRef} className="flex-1 overflow-y-auto no-scrollbar content-scroll-area bg-white">
                                    <div className="p-8 pb-32 flex flex-col items-center">
                                        <div className="max-w-xl w-full">
                                            {currentDisplayItem.quote && (
                                                <div className={`quote-style mb-12 text-center font-medium text-gray-500 whitespace-pre-wrap border-y-2 border-gray-100 py-16 bg-gray-50/50 px-10 rounded-3xl ${getFontSizeClass('quote')}`} style={{ fontStyle: 'normal' }}>
                                                    {currentDisplayItem.quote}
                                                </div>
                                            )}

                                            <article className="flex justify-center w-full">
                                                <div className={`w-full max-w-2xl text-left whitespace-pre-wrap font-normal text-gray-800 leading-relaxed ${getFontSizeClass('content')}`}>
                                                    {currentDisplayItem.content || null}
                                                </div>
                                            </article>

                                            {!isLastItem() && (
                                                <div className="mt-20 pt-10 border-t border-gray-100 w-full flex justify-center animate-content">
                                                    <button onClick={goToNext} className="w-full py-8 bg-blue-700 text-white rounded-[2.5rem] shadow-xl flex items-center justify-center gap-4 active:scale-[0.98] active:bg-blue-800 transition-all shadow-blue-200">
                                                        <span className="text-3xl font-black tracking-widest uppercase">下一頁</span>
                                                        <Icons.ArrowRight />
                                                    </button>
                                                </div>
                                            )}

                                            {isLastItem() && (
                                                <div className="mt-20 text-center text-gray-300 font-black text-sm uppercase tracking-[0.4em] py-10 border-t border-gray-50">End of Document</div>
                                            )}
                                        </div>
                                    </div>
                                </section>
                            </div>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center bg-gray-50 p-12 text-center animate-content">
                                <div className="text-blue-700 mb-8 opacity-60">
                                    <Icons.RefreshCw />
                                </div>
                                <h2 className="text-2xl font-black text-gray-400 tracking-tighter uppercase text-center">正在同步最新導覽內容...</h2>
                            </div>
                        )}
                    </div>

                    {/* 底部導覽列 */}
                    {data.length > 0 && (
                        <footer 
                            className="fixed bottom-0 left-0 right-0 h-24 bg-blue-700 text-white flex items-center justify-center z-40 shadow-[0_-10px_30px_rgba(30,64,175,0.3)] pb-safe transition-colors"
                        >
                            <div className="flex items-center gap-8 md:gap-12 w-full justify-center px-6">
                                {/* 左側：字體放大按鈕 */}
                                <button 
                                    onClick={(e) => { e.stopPropagation(); toggleFontSize(); }}
                                    className="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center border-2 border-blue-500 shadow-lg active:scale-95 transition-transform shrink-0"
                                >
                                    <span className={`font-serif font-bold transition-all ${getFontSizeClass('icon')}`}>
                                        字
                                    </span>
                                </button>

                                {/* 中間：目錄按鈕 */}
                                <button
                                    onClick={() => setIsMenuOpen(true)}
                                    className="flex items-center gap-3 active:scale-95 transition-transform"
                                >
                                    <Icons.Menu />
                                    <span className="text-3xl font-black tracking-[0.2em] uppercase">目錄</span>
                                </button>

                                {/* 右側：語音朗讀按鈕 ✨ 樣式優化 */}
                                <button 
                                    onClick={(e) => { e.stopPropagation(); toggleSpeech(); }}
                                    className={`w-14 h-14 rounded-2xl flex items-center justify-center border-2 shadow-lg active:scale-95 transition-all shrink-0 
                                        ${isSpeaking 
                                            ? 'bg-white text-blue-600 border-blue-600 animate-pulse' 
                                            : 'bg-blue-600 text-white border-blue-500'}`}
                                >
                                    <Icons.Volume2 />
                                </button>
                            </div>
                        </footer>
                    )}
                </div>
            );
        };

        const MediaRenderer = ({ content, placeholder }) => {
            if (!content) return <img src={placeholder} className="w-full h-full object-cover opacity-40 grayscale" />;
            if (content.trim().startsWith('<')) return <div className="w-full h-full bg-black flex items-center justify-center relative" dangerouslySetInnerHTML={{ __html: content }} />;
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const ytMatch = content.match(youtubeRegex);
            if (ytMatch) return <iframe className="w-full h-full bg-black" src={`https://www.youtube.com/embed/${ytMatch[1]}?autoplay=0&rel=0`} frameBorder="0" allowFullScreen></iframe>;
            const videoRegex = /\.(mp4|webm|ogg|mov)$/i;
            if (videoRegex.test(content)) return <video className="w-full h-full object-contain bg-black" controls playsInline><source src={content} /></video>;
            return <img src={content} className="w-full h-full object-cover animate-fadeIn" />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'guide-v2';
                self.addEventListener('install', (e) => {
                    self.skipWaiting();
                    e.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll([location.href])));
                });
                self.addEventListener('activate', (e) => {
                    e.waitUntil(clients.claim());
                });
                self.addEventListener('fetch', (e) => {
                    e.respondWith(caches.match(e.request).then((res) => res || fetch(e.request)));
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch((err) => console.log('SW ERR:', err));
        }
    </script>
</body>
</html>
